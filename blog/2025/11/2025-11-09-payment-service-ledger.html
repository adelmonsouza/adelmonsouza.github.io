<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Day 9/30 â€” Payment Service, Ledgers, and Idempotent Webhooks Â· The Java Place</title>
  <meta name="description" content="Day 9 do #30DiasJava: Payment Service com ledger imutÃ¡vel, integraÃ§Ãµes Stripe/MBWay, webhooks idempotentes, reconciliaÃ§Ã£o e observabilidade financeira." />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="canonical" href="https://enouveau.io/blog/2025/11/2025-11-09-payment-service-ledger.html" />
  <meta property="og:title" content="Day 9/30 â€” Payment Service, Ledgers, and Idempotent Webhooks" />
  <meta property="og:description" content="Day 9 do #30DiasJava: Payment Service com ledger imutÃ¡vel, integraÃ§Ãµes Stripe/MBWay, webhooks idempotentes, reconciliaÃ§Ã£o e observabilidade financeira." />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://enouveau.io/blog/2025/11/2025-11-09-payment-service-ledger.html" />
  <meta property="article:published_time" content="2025-11-09T00:00:00.000Z" />
  <meta property="article:tag" content="Java" />
  <meta property="article:tag" content="Spring Boot" />
  <meta property="article:tag" content="Payments" />
  <meta property="article:tag" content="Ledger" />
  <meta property="article:tag" content="Webhooks" />
</head>
<body>
  <div class="background-glow"></div>
  <div class="app-shell">
    <header class="masthead">
  <div class="brand">
    <span>ğŸš€</span>
    <span>The Java Place</span>
  </div>
  <nav class="main-nav">
    <a href="/">Home</a>
    <a href="/blog/">Blog</a>
    <a href="/start-line/season-1-becoming-developer.html">Start Line</a>
    <a href="/resources/">Resources</a>
  </nav>
</header>
    
      <a class="back-link" href="/blog/">&larr; Voltar para o blog</a>
      <article class="article">
        <header>
          <span class="pill">30DaysOfJava</span>
          <h1>Day 9/30 â€” Payment Service, Ledgers, and Idempotent Webhooks</h1>
          <p>Day 9 do #30DiasJava: Payment Service com ledger imutÃ¡vel, integraÃ§Ãµes Stripe/MBWay, webhooks idempotentes, reconciliaÃ§Ã£o e observabilidade financeira.</p>
          <div class="meta-line">
            <span>ğŸ“… 09 de novembro de 2025</span>
            <span>â±ï¸ 1 min read</span>
            <span>ğŸ—‚ï¸ 30DaysOfJava</span>
          </div>
        </header>
        <div class="article-body">
          <blockquote>
<p>â€œPagamento em produÃ§Ã£o Ã© assunto sÃ©rio: sem idempotÃªncia, sem deploy.â€ â€” <em>#30DiasJava Finance Log</em></p>
</blockquote>
<h2>ğŸ¯ Objetivo do Day 9</h2>
<p>O nono dia do #30DiasJava mergulhou em pagamentos. A meta: criar um <strong>Payment Service</strong> com ledger imutÃ¡vel, integraÃ§Ãµes com Stripe e MBWay e observabilidade financeira digna de auditoria.</p>
<h2>ğŸ› ï¸ Destaques da implementaÃ§Ã£o</h2>
<ul>
<li><strong>Ledger imutÃ¡vel</strong>: tabela <code>payment_ledger</code> guarda cada transiÃ§Ã£o (<code>AUTHORIZED</code>, <code>CAPTURED</code>, <code>REFUNDED</code>). Nada de <code>UPDATE</code> â€” novos registros contam a histÃ³ria completa.</li>
<li><strong>IdempotÃªncia real</strong>: <code>ON CONFLICT DO NOTHING</code> + Ã­ndices Ãºnicos (<code>provider</code>, <code>provider_payment_id</code>) previnem duplicatas. Redis segura nonces de callbacks.</li>
<li><strong>Webhooks seguros</strong>: Stripe usa verificaÃ§Ã£o HMAC (<code>Stripe-Signature</code>); MBWay valida certificados X.509 antes de processar.</li>
<li><strong>Eventos financeiros</strong>: apÃ³s <code>CAPTURED</code>, publicamos <code>PaymentReceivedEvent</code> para alimentar XP, relatÃ³rios e notificaÃ§Ãµes.</li>
<li><strong>ReconciliaÃ§Ã£o diÃ¡ria</strong>: job <code>reconcile-payments</code> compara ledger Ã— provedor e registra divergÃªncias em <code>payment_reconciliation_issue</code>.</li>
</ul>
<h2>ğŸ’¡ LiÃ§Ãµes do dia</h2>
<ul>
<li>Tokens do provedor sÃ£o o Ãºnico caminho â€” dados de cartÃ£o nunca tocam nosso banco.</li>
<li>Auditoria exige metadados ricos: <code>schemaVersion</code>, <code>taxes</code>, <code>exchangeRate</code> e <code>traceId</code> em cada entrada.</li>
<li>MÃ©tricas como <code>payment_idempotency_conflicts_total</code> ajudam a detectar problemas antes do financeiro avisar.</li>
</ul>
<h2>ğŸ”— Recursos</h2>
<ul>
<li>Artigo completo: <a href="https://enouveau.io/blog/2025/11/09/payment-service-ledger.html">https://enouveau.io/blog/2025/11/09/payment-service-ledger.html</a></li>
<li>RepositÃ³rio: <a href="https://github.com/adelmonsouza/30DiasJava-Day09-Payment">https://github.com/adelmonsouza/30DiasJava-Day09-Payment</a></li>
<li><strong>Projeto pessoal:</strong> Este Ã© um projeto do desafio #30DiasJava, mantido independentemente para fins educacionais.</li>
</ul>
<hr>
<p><strong>Next episode</strong> â†’ <a href="../2025-11-10-reporting-service-streaming.html">Day 10/30 â€” Reporting Service em Spring Boot</a></p>

        </div>
        <footer class="meta-line">
          <span>Compartilhe no LinkedIn e marque @adelmon</span>
          
        </footer>
      </article>
    
  </div>
  <footer class="site-footer">
  Â© 2025 E-Nouveau â€” The Java Place. Sem fluff, apenas engenharia de verdade.
</footer>
</body>
</html>