<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Day 19/30 â€” OAuth2 Social Login Â· The Java Place</title>
  <meta name="description" content="Day 19 do #30DiasJava: OAuth2 social login com Google, Apple e Microsoft, validaÃ§Ã£o de tokens, criaÃ§Ã£o automÃ¡tica de contas e vinculaÃ§Ã£o com contas existentes." />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="canonical" href="https://enouveau.io/blog/2025/11/2025-11-19-oauth2-social-login.html" />
  <meta property="og:title" content="Day 19/30 â€” OAuth2 Social Login" />
  <meta property="og:description" content="Day 19 do #30DiasJava: OAuth2 social login com Google, Apple e Microsoft, validaÃ§Ã£o de tokens, criaÃ§Ã£o automÃ¡tica de contas e vinculaÃ§Ã£o com contas existentes." />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://enouveau.io/blog/2025/11/2025-11-19-oauth2-social-login.html" />
  <meta property="article:published_time" content="2025-11-19T00:00:00.000Z" />
  <meta property="article:tag" content="Spring Boot" />
  <meta property="article:tag" content="Security" />
  <meta property="article:tag" content="OAuth2" />
  <meta property="article:tag" content="Social Login" />
  <meta property="article:tag" content="Authentication" />
</head>
<body>
  <div class="background-glow"></div>
  <div class="app-shell">
    <header class="masthead">
  <div class="brand">
    <span>ğŸš€</span>
    <span>The Java Place</span>
  </div>
  <nav class="main-nav">
    <a href="/">Home</a>
    <a href="/blog/">Blog</a>
    <a href="/start-line/season-1-becoming-developer.html">Start Line</a>
    <a href="/resources/">Resources</a>
  </nav>
</header>
    
      <a class="back-link" href="/blog/">&larr; Voltar para o blog</a>
      <article class="article">
        <header>
          <span class="pill">30DaysOfJava</span>
          <h1>Day 19/30 â€” OAuth2 Social Login</h1>
          <p>Day 19 do #30DiasJava: OAuth2 social login com Google, Apple e Microsoft, validaÃ§Ã£o de tokens, criaÃ§Ã£o automÃ¡tica de contas e vinculaÃ§Ã£o com contas existentes.</p>
          <div class="meta-line">
            <span>ğŸ“… 19 de novembro de 2025</span>
            <span>â±ï¸ 8 min read</span>
            <span>ğŸ—‚ï¸ 30DaysOfJava</span>
          </div>
        </header>
        <div class="article-body">
          <blockquote>
<p>&quot;Social login reduz fricÃ§Ã£o de onboarding e aumenta conversÃ£o. Mas validaÃ§Ã£o de tokens Ã© crÃ­tica para seguranÃ§a.&quot; â€” <em>#30DiasJava Security Notes</em></p>
</blockquote>
<h2>ğŸ¯ Objetivo do Day 19</h2>
<p>Para permitir que usuÃ¡rios faÃ§am login usando suas contas sociais (Google, Apple, Microsoft), o Day 19 do #30DiasJava implementou <strong>OAuth2 Social Login</strong> com validaÃ§Ã£o de tokens, criaÃ§Ã£o automÃ¡tica de contas e vinculaÃ§Ã£o com contas existentes.</p>
<h2>ğŸ› ï¸ O que foi implementado</h2>
<h3>âœ… OAuth2 Token Validation</h3>
<ul>
<li><strong>Google token validation</strong>: ValidaÃ§Ã£o de ID tokens do Google usando Google API Client</li>
<li><strong>Apple token validation</strong>: Estrutura para validaÃ§Ã£o de tokens Apple (TODO: implementaÃ§Ã£o completa)</li>
<li><strong>Microsoft token validation</strong>: Estrutura para validaÃ§Ã£o de tokens Microsoft (TODO: implementaÃ§Ã£o completa)</li>
<li><strong>Token verification</strong>: VerificaÃ§Ã£o de assinatura e claims dos tokens</li>
</ul>
<h3>âœ… User Account Management</h3>
<ul>
<li><strong>Automatic account creation</strong>: CriaÃ§Ã£o automÃ¡tica de contas para novos usuÃ¡rios OAuth2</li>
<li><strong>Account linking</strong>: VinculaÃ§Ã£o de OAuth2 a contas existentes (por email)</li>
<li><strong>Provider tracking</strong>: Rastreamento de provedor OAuth2 (GOOGLE, APPLE, MICROSOFT)</li>
<li><strong>Unique username generation</strong>: GeraÃ§Ã£o de usernames Ãºnicos baseados em email + provider</li>
</ul>
<h3>âœ… Social Login Flow</h3>
<ul>
<li><strong>Social login endpoint</strong>: Endpoint <code>/auth/social</code> para login social</li>
<li><strong>Token validation</strong>: ValidaÃ§Ã£o de token antes de criar/autenticar usuÃ¡rio</li>
<li><strong>MFA integration</strong>: VerificaÃ§Ã£o de MFA tambÃ©m para login social</li>
<li><strong>JWT token generation</strong>: GeraÃ§Ã£o de JWT apÃ³s autenticaÃ§Ã£o social bem-sucedida</li>
</ul>
<h3>âœ… Database Schema</h3>
<ul>
<li><strong>Email field</strong>: Campo <code>email</code> na tabela <code>users</code> para vinculaÃ§Ã£o</li>
<li><strong>Provider ID</strong>: Campo <code>provider_id</code> para ID Ãºnico do provedor</li>
<li><strong>Auth provider</strong>: Campo <code>auth_provider</code> para identificar provedor (GOOGLE, APPLE, MICROSOFT)</li>
<li><strong>Nullable password</strong>: Campo <code>password_hash</code> nullable para usuÃ¡rios apenas OAuth2</li>
</ul>
<h2>ğŸ“Š Arquitetura</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OAuth2 Provider (Google/Apple/MS)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Google     â”‚  â”‚    Apple     â”‚  â”‚  Microsoft   â”‚ â”‚
â”‚  â”‚   Sign-In    â”‚  â”‚  Sign-In     â”‚  â”‚  Sign-In     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ ID Token
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Frontend Application                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  POST /auth/social                                â”‚  â”‚
â”‚  â”‚  { &quot;idToken&quot;: &quot;...&quot;, &quot;provider&quot;: &quot;GOOGLE&quot; }       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AuthController                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  @PostMapping(&quot;/social&quot;)                          â”‚  â”‚
â”‚  â”‚  socialLogin(SocialLoginRequest)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OAuth2Service                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Validate    â”‚  â”‚   Extract    â”‚  â”‚   Return    â”‚ â”‚
â”‚  â”‚   Token      â”‚  â”‚   User Info   â”‚  â”‚   UserInfo  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Google     â”‚ â”‚    Apple     â”‚ â”‚  Microsoft   â”‚
â”‚   Verifier   â”‚ â”‚  (TODO)      â”‚ â”‚  (TODO)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              User Repository                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Find by     â”‚  â”‚  Create new  â”‚  â”‚  Link to     â”‚ â”‚
â”‚  â”‚  provider    â”‚  â”‚   user       â”‚  â”‚  existing    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              JWT Token Generation                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h2>ğŸ’» ImplementaÃ§Ã£o</h2>
<h3>DependÃªncias (pom.xml)</h3>
<pre><code class="language-xml">&lt;!-- OAuth2 Client --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.google.api-client&lt;/groupId&gt;
  &lt;artifactId&gt;google-api-client&lt;/artifactId&gt;
  &lt;version&gt;2.2.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h3>Database Migration (V1001__add_social_auth_fields.sql)</h3>
<pre><code class="language-sql">-- Add email, provider_id, auth_provider to users table
ALTER TABLE users 
  ADD COLUMN IF NOT EXISTS email VARCHAR(255),
  ADD COLUMN IF NOT EXISTS provider_id VARCHAR(255),
  ADD COLUMN IF NOT EXISTS auth_provider VARCHAR(50);

-- Make password_hash nullable (OAuth2 users don&#39;t have passwords)
ALTER TABLE users 
  ALTER COLUMN password_hash DROP NOT NULL;

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_provider ON users(provider_id, auth_provider);
</code></pre>
<h3>OAuth2Service</h3>
<pre><code class="language-java">@Service
public class OAuth2Service {
    private final GoogleIdTokenVerifier googleVerifier;
    private final String googleClientId;

    public OAuth2Service(@Value(&quot;${app.oauth2.google.client-id:}&quot;) String googleClientId) {
        this.googleClientId = googleClientId;
        
        // Inicializar Google verifier apenas se client ID estiver configurado
        if (googleClientId != null &amp;&amp; !googleClientId.isEmpty()) {
            this.googleVerifier = new GoogleIdTokenVerifier.Builder(
                new NetHttpTransport(),
                new GsonFactory()
            )
            .setAudience(Collections.singletonList(googleClientId))
            .build();
        } else {
            this.googleVerifier = null;
        }
    }

    public OAuth2UserInfo validateToken(String idToken, String provider) {
        return switch (provider.toUpperCase()) {
            case &quot;GOOGLE&quot; -&gt; validateGoogleToken(idToken);
            case &quot;APPLE&quot; -&gt; validateAppleToken(idToken);
            case &quot;MICROSOFT&quot; -&gt; validateMicrosoftToken(idToken);
            default -&gt; throw new IllegalArgumentException(&quot;Unsupported OAuth2 provider: &quot; + provider);
        };
    }

    private OAuth2UserInfo validateGoogleToken(String idToken) {
        if (googleVerifier == null) {
            // Em desenvolvimento, aceitar token sem validaÃ§Ã£o real
            // Em produÃ§Ã£o, sempre validar
            return new OAuth2UserInfo(
                &quot;dev-user-&quot; + System.currentTimeMillis() + &quot;@google.local&quot;,
                &quot;google_&quot; + System.currentTimeMillis(),
                &quot;Google User&quot;
            );
        }

        try {
            GoogleIdToken token = googleVerifier.verify(idToken);
            if (token == null) {
                throw new IllegalArgumentException(&quot;Invalid Google ID token&quot;);
            }

            GoogleIdToken.Payload payload = token.getPayload();
            String email = payload.getEmail();
            String userId = payload.getSubject();
            String name = (String) payload.get(&quot;name&quot;);

            return new OAuth2UserInfo(email, userId, name);
        } catch (Exception e) {
            throw new IllegalArgumentException(&quot;Failed to validate Google token: &quot; + e.getMessage(), e);
        }
    }

    private OAuth2UserInfo validateAppleToken(String idToken) {
        // TODO: Implementar validaÃ§Ã£o real do Apple ID token
        // Apple usa JWT assinado com chave pÃºblica da Apple
        return new OAuth2UserInfo(
            &quot;dev-user-&quot; + System.currentTimeMillis() + &quot;@apple.local&quot;,
            &quot;apple_&quot; + System.currentTimeMillis(),
            &quot;Apple User&quot;
        );
    }

    private OAuth2UserInfo validateMicrosoftToken(String idToken) {
        // TODO: Implementar validaÃ§Ã£o real do Microsoft Azure AD token
        // Microsoft usa JWT assinado com chave pÃºblica do Azure AD
        return new OAuth2UserInfo(
            &quot;dev-user-&quot; + System.currentTimeMillis() + &quot;@microsoft.local&quot;,
            &quot;microsoft_&quot; + System.currentTimeMillis(),
            &quot;Microsoft User&quot;
        );
    }

    public record OAuth2UserInfo(
        String email,
        String providerId,
        String name
    ) {}
}
</code></pre>
<h3>AuthController Social Login</h3>
<pre><code class="language-java">@PostMapping(&quot;/social&quot;)
public TokenResponse socialLogin(@Valid @RequestBody SocialLoginRequest req) {
    // Validar token OAuth2 com o provedor
    OAuth2Service.OAuth2UserInfo userInfo = oauth2Service.validateToken(
        req.idToken(), 
        req.provider()
    );
    
    // Verificar se usuÃ¡rio jÃ¡ existe pelo provider
    String provider = req.provider().toUpperCase();
    var existingUser = users.findByProviderIdAndAuthProvider(
        userInfo.providerId(), 
        provider
    )
    .orElseGet(() -&gt; {
        // Verificar se email jÃ¡ existe (usuÃ¡rio pode ter se registrado com email/password)
        var userByEmail = users.findByEmail(userInfo.email()).orElse(null);
        
        if (userByEmail != null) {
            // Vincular OAuth2 a conta existente
            userByEmail.setProviderId(userInfo.providerId());
            userByEmail.setAuthProvider(provider);
            if (userByEmail.getEmail() == null) {
                userByEmail.setEmail(userInfo.email());
            }
            users.save(userByEmail);
            return userByEmail;
        }
        
        // Criar novo usuÃ¡rio
        String username = generateUniqueUsername(provider, userInfo.email());
        var u = new AppUser();
        u.setUsername(username);
        u.setEmail(userInfo.email());
        u.setProviderId(userInfo.providerId());
        u.setAuthProvider(provider);
        u.setRoles(Set.of(&quot;USER&quot;));
        u.setEnabled(true);
        users.save(u);
        return u;
    });
    
    // Verificar se MFA estÃ¡ habilitado (mesmo para login social)
    boolean mfaRequired = mfaService.isMfaEnabled(existingUser.getId());
    if (mfaRequired) {
        throw new IllegalStateException(
            &quot;MFA verification required. Please use /auth/login/mfa endpoint.&quot;
        );
    }
    
    return new TokenResponse(
        jwt.generateToken(existingUser.getUsername(), existingUser.getRoles())
    );
}

private String generateUniqueUsername(String provider, String email) {
    // Usar email como base, removendo @ e domÃ­nio
    String base = email.split(&quot;@&quot;)[0].toLowerCase().replaceAll(&quot;[^a-z0-9]&quot;, &quot;&quot;);
    String username = base + &quot;_&quot; + provider.toLowerCase();
    
    // Garantir unicidade
    int counter = 0;
    String finalUsername = username;
    while (users.existsByUsername(finalUsername)) {
        counter++;
        finalUsername = username + counter;
    }
    
    return finalUsername;
}
</code></pre>
<h3>Configuration (application.yml)</h3>
<pre><code class="language-yaml">app:
  oauth2:
    google:
      client-id: ${GOOGLE_CLIENT_ID:}
      # client-secret nÃ£o necessÃ¡rio para ID token validation
</code></pre>
<h2>ğŸ“ˆ Fluxo de Uso</h2>
<h3>1. Google Sign-In (Frontend)</h3>
<pre><code class="language-javascript">// Frontend: Google Sign-In
async function handleGoogleSignIn() {
  const response = await google.accounts.oauth2.initTokenClient({
    client_id: &#39;YOUR_GOOGLE_CLIENT_ID&#39;,
    scope: &#39;email profile&#39;,
    callback: async (tokenResponse) =&gt; {
      // Obter ID token
      const idToken = tokenResponse.access_token;
      
      // Enviar para backend
      const result = await fetch(&#39;/auth/social&#39;, {
        method: &#39;POST&#39;,
        headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
        body: JSON.stringify({
          idToken: idToken,
          provider: &#39;GOOGLE&#39;
        })
      });
      
      const data = await result.json();
      // Salvar JWT token
      localStorage.setItem(&#39;auth_token&#39;, data.token);
    }
  });
  
  response.requestAccessToken();
}
</code></pre>
<h3>2. Social Login Request</h3>
<pre><code class="language-bash"># POST /auth/social
curl -X POST http://localhost:8080/auth/social \
  -H &quot;Content-Type: application/json&quot; \
  -d &#39;{
    &quot;idToken&quot;: &quot;eyJhbGciOiJSUzI1NiIsImtpZCI6Ij...&quot;,
    &quot;provider&quot;: &quot;GOOGLE&quot;
  }&#39;

# Resposta (novo usuÃ¡rio):
{
  &quot;token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;
}

# Resposta (usuÃ¡rio existente):
{
  &quot;token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;
}
</code></pre>
<h3>3. Account Linking</h3>
<p>Se um usuÃ¡rio jÃ¡ tem conta com email <code>user@example.com</code> e faz login social com o mesmo email, a conta Ã© automaticamente vinculada:</p>
<pre><code class="language-sql">-- Antes do login social
SELECT * FROM users WHERE email = &#39;user@example.com&#39;;
-- id: 1, username: &#39;user&#39;, provider_id: NULL, auth_provider: NULL

-- ApÃ³s login social com Google
SELECT * FROM users WHERE email = &#39;user@example.com&#39;;
-- id: 1, username: &#39;user&#39;, provider_id: &#39;google_123456&#39;, auth_provider: &#39;GOOGLE&#39;
</code></pre>
<h2>ğŸ“ LiÃ§Ãµes Aprendidas</h2>
<h3>âœ… O que funcionou bem</h3>
<ul>
<li><strong>Google token validation</strong>: Google API Client facilita validaÃ§Ã£o de tokens</li>
<li><strong>Account linking</strong>: VinculaÃ§Ã£o automÃ¡tica por email reduz duplicaÃ§Ã£o de contas</li>
<li><strong>Unique username generation</strong>: GeraÃ§Ã£o automÃ¡tica de usernames evita conflitos</li>
<li><strong>MFA integration</strong>: Login social tambÃ©m respeita MFA quando habilitado</li>
</ul>
<h3>âš ï¸ Desafios e soluÃ§Ãµes</h3>
<ul>
<li><strong>Apple/Microsoft validation</strong>: Ainda nÃ£o implementado. Requer validaÃ§Ã£o de JWT com chaves pÃºblicas dos provedores.</li>
<li><strong>Token expiration</strong>: Tokens OAuth2 expiram. Frontend deve lidar com refresh tokens.</li>
<li><strong>Development mode</strong>: Em desenvolvimento, aceitamos tokens sem validaÃ§Ã£o real. Em produÃ§Ã£o, sempre validar.</li>
</ul>
<h2>ğŸ“š Recursos</h2>
<ul>
<li>Spring OAuth2 Client: <a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/client/index.html">https://docs.spring.io/spring-security/reference/servlet/oauth2/client/index.html</a></li>
<li>Google Sign-In: <a href="https://developers.google.com/identity/sign-in/web">https://developers.google.com/identity/sign-in/web</a></li>
<li>Apple Sign-In: <a href="https://developer.apple.com/sign-in-with-apple/">https://developer.apple.com/sign-in-with-apple/</a></li>
<li>Microsoft Azure AD: <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/">https://docs.microsoft.com/en-us/azure/active-directory/develop/</a></li>
</ul>
<h2>ğŸ”— Links</h2>
<ul>
<li>RepositÃ³rio: <a href="https://github.com/adelmonsouza/30DiasJava-Day19-OAuth2">https://github.com/adelmonsouza/30DiasJava-Day19-OAuth2</a></li>
</ul>
<p><strong>Next episode</strong> â†’ Day 20/30 â€” Rate Limiting com Redis</p>

        </div>
        <footer class="meta-line">
          <span>Compartilhe no LinkedIn e marque @adelmon</span>
          <a href="https://github.com/adelmonsouza/30DiasJava-Day19-OAuth2" target="_blank" rel="noopener noreferrer nofollow">CÃ³digo no GitHub</a>
        </footer>
      </article>
    
  </div>
  <footer class="site-footer">
  Â© 2025 E-Nouveau â€” The Java Place. Sem fluff, apenas engenharia de verdade.
</footer>
</body>
</html>